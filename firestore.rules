rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // SECURITY HELPER FUNCTIONS
    // ========================================================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if user is the teacher of a classroom
    function isTeacher(classroomId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid;
    }
    
    // Check if student is enrolled in classroom (exists in live_students)
    function isEnrolledStudent(classroomId) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/classrooms/$(classroomId)/live_students/$(request.auth.uid));
    }
    
    // [REMOVED] isEnrolledInAnyAssignedRoom - complexity causes query failures
    

    
    // Validate student display name: 2-16 chars, letters/spaces only if possible
    function isValidDisplayName(name) {
      return name is string && 
             name.size() >= 2 && 
             name.size() <= 16;
    }
    
    // Validate student message: max 200 chars
    function isValidMessage(msg) {
      return msg == null || (msg is string && msg.size() <= 200);
    }
    
    // Validate task status
    function isValidStatus(status) {
      return status in ['todo', 'in_progress', 'stuck', 'question', 'done'];
    }
    
    // ========================================================================
    // CLASSROOMS COLLECTION
    // ========================================================================
    match /classrooms/{classroomId} {
      // SECURITY: Explicit get/list separation (no conflicting 'read' rule)
      // 
      // 'get' (fetch by document ID): Teachers or enrolled students only
      allow get: if isTeacher(classroomId) || isEnrolledStudent(classroomId);
      
      // 'list' (queries): Allow unauthenticated for join code lookup
      // IMPORTANT: The join flow queries by joinCode BEFORE signing in anonymously
      // This is intentional - students need to verify the code exists before auth
      // Security: Can only find classrooms if you know the exact 6-char code
      allow list: if true;
      
      // Teachers can create new classrooms (validate join code format)
      allow create: if isSignedIn() && 
                       request.resource.data.teacherId == request.auth.uid &&
                       request.resource.data.joinCode.size() == 6 &&
                       request.resource.data.joinCode.matches('^[A-Z0-9]+$');
      
      // Teachers can update/delete their own classrooms
      allow update, delete: if isSignedIn() && resource.data.teacherId == request.auth.uid;
      
      // ======================================================================
      // LIVE STUDENTS SUBCOLLECTION - Tightened security
      // ======================================================================
      match /live_students/{studentId} {
        // Teachers can read all students; Students can read their own
        allow read: if isSignedIn() && (request.auth.uid == studentId || isTeacher(classroomId));
        
        // Students can create their own document
        allow create: if isSignedIn() && request.auth.uid == studentId &&
                         isValidDisplayName(request.resource.data.displayName);
        
        // Students can update their own document
        allow update: if isSignedIn() && request.auth.uid == studentId &&
                         (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['displayName']) || 
                          isValidDisplayName(request.resource.data.displayName));
        
        // Students and teachers can delete
        allow delete: if isSignedIn() && (request.auth.uid == studentId || isTeacher(classroomId));
      }
      
    }
    
    // ========================================================================
    // TOP-LEVEL TASKS COLLECTION (for TaskManager)
    // ========================================================================
    match /tasks/{taskId} {
      // NOTE: We rely on "Authenticated + ID Match" queries.
      // Since filtering by array-contains is hard to validate perfectly in rules without custom claims,
      // we allow any authenticated user to read tasks (which prevents public access).
      // The application logic ensures students only query for their specific room.
      allow read: if isSignedIn();
      
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.teacherId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.teacherId;
    }
    
    // ========================================================================
    // ANALYTICS LOGS COLLECTION
    // ========================================================================
    match /analytics_logs/{logId} {
      // Teachers can read analytics for their classrooms
      allow read: if isSignedIn() && get(/databases/$(database)/documents/classrooms/$(resource.data.classroomId)).data.teacherId == request.auth.uid;
      
      // Teachers can create analytics for their classrooms
      allow create: if isSignedIn() && get(/databases/$(database)/documents/classrooms/$(request.resource.data.classroomId)).data.teacherId == request.auth.uid;
      
      // Teachers can update analytics
      allow update: if isSignedIn() && get(/databases/$(database)/documents/classrooms/$(resource.data.classroomId)).data.teacherId == request.auth.uid;
      
      // Teachers can delete analytics from their classrooms
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/classrooms/$(resource.data.classroomId)).data.teacherId == request.auth.uid;
    }
  }
}
