rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // SECURITY HELPER FUNCTIONS
    // ========================================================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if user is the teacher of a classroom
    function isTeacher(classroomId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/classrooms/$(classroomId)).data.teacherId == request.auth.uid;
    }
    
    // Check if student is enrolled in classroom (exists in live_students)
    function isEnrolledStudent(classroomId) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/classrooms/$(classroomId)/live_students/$(request.auth.uid));
    }
    
    // Check if student is enrolled in ANY of the task's assigned classrooms
    function isEnrolledInAnyAssignedRoom(taskData) {
      let roomIds = taskData.get('selectedRoomIds', []);
      // Security: Check if current student is in live_students for any assigned room
      // Note: Firestore security rules actually support testing existence in a list via hasAny if we restructure,
      // but for now we'll stick to a slightly cleaner loop-free approach or better-indexed access.
      // Maximum 10 exists() calls allowed in a request.
      return roomIds.size() > 0 && (
        exists(/databases/$(database)/documents/classrooms/$(roomIds[0])/live_students/$(request.auth.uid)) ||
        (roomIds.size() > 1 && exists(/databases/$(database)/documents/classrooms/$(roomIds[1])/live_students/$(request.auth.uid))) ||
        (roomIds.size() > 2 && exists(/databases/$(database)/documents/classrooms/$(roomIds[2])/live_students/$(request.auth.uid))) ||
        (roomIds.size() > 3 && exists(/databases/$(database)/documents/classrooms/$(roomIds[3])/live_students/$(request.auth.uid))) ||
        (roomIds.size() > 4 && exists(/databases/$(database)/documents/classrooms/$(roomIds[4])/live_students/$(request.auth.uid))) ||
        (roomIds.size() > 5 && exists(/databases/$(database)/documents/classrooms/$(roomIds[5])/live_students/$(request.auth.uid))) ||
        (roomIds.size() > 6 && exists(/databases/$(database)/documents/classrooms/$(roomIds[6])/live_students/$(request.auth.uid))) ||
        (roomIds.size() > 7 && exists(/databases/$(database)/documents/classrooms/$(roomIds[7])/live_students/$(request.auth.uid))) ||
        (roomIds.size() > 8 && exists(/databases/$(database)/documents/classrooms/$(roomIds[8])/live_students/$(request.auth.uid))) ||
        (roomIds.size() > 9 && exists(/databases/$(database)/documents/classrooms/$(roomIds[9])/live_students/$(request.auth.uid)))
      );
    }
    

    
    // Validate student display name: letters/spaces only, 2-12 chars
    function isValidDisplayName(name) {
      return name is string && 
             name.size() >= 2 && 
             name.size() <= 12 &&
             name.matches('^[a-zA-Z\\s]+$');
    }
    
    // Validate student message: max 200 chars
    function isValidMessage(msg) {
      return msg == null || (msg is string && msg.size() <= 200);
    }
    
    // Validate task status
    function isValidStatus(status) {
      return status in ['todo', 'in_progress', 'stuck', 'question', 'done'];
    }
    
    // ========================================================================
    // CLASSROOMS COLLECTION
    // ========================================================================
    match /classrooms/{classroomId} {
      // SECURITY: Explicit get/list separation (no conflicting 'read' rule)
      // 
      // 'get' (fetch by document ID): Teachers or enrolled students only
      allow get: if isTeacher(classroomId) || isEnrolledStudent(classroomId);
      
      // 'list' (queries): Allow unauthenticated for join code lookup
      // IMPORTANT: The join flow queries by joinCode BEFORE signing in anonymously
      // This is intentional - students need to verify the code exists before auth
      // Security: Can only find classrooms if you know the exact 6-char code
      allow list: if true;
      
      // Teachers can create new classrooms (validate join code format)
      allow create: if isSignedIn() && 
                       request.resource.data.teacherId == request.auth.uid &&
                       request.resource.data.joinCode.size() == 6 &&
                       request.resource.data.joinCode.matches('^[A-Z0-9]+$');
      
      // Teachers can update/delete their own classrooms
      allow update, delete: if isSignedIn() && resource.data.teacherId == request.auth.uid;
      
      // ======================================================================
      // LIVE STUDENTS SUBCOLLECTION - Tightened security
      // ======================================================================
      match /live_students/{studentId} {
        // Teachers can read all students in their classroom
        allow read: if isTeacher(classroomId);
        
        // Students can read their own data
        allow read: if isSignedIn() && request.auth.uid == studentId;
        
        // Students can create their own document with validated data
        allow create: if (isSignedIn() && request.auth.uid == studentId &&
                         isValidDisplayName(request.resource.data.displayName) &&
                         isValidStatus(request.resource.data.currentStatus)) ||
                        isTeacher(classroomId);
        
        // Students can update their own document with validated data
        allow update: if (isSignedIn() && request.auth.uid == studentId &&
                         // Validate displayName if being changed
                         (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['displayName']) || 
                          isValidDisplayName(request.resource.data.displayName)) &&
                         // Validate currentStatus if being changed
                         (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['currentStatus']) || 
                          isValidStatus(request.resource.data.currentStatus)) &&
                         // Validate currentMessage if being changed
                         (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['currentMessage']) || 
                          isValidMessage(request.resource.data.currentMessage))) ||
                        isTeacher(classroomId);
        
        // Students and teachers can delete
        allow delete: if isSignedIn() && (request.auth.uid == studentId || isTeacher(classroomId));
      }
      
    }
    
    // ========================================================================
    // TOP-LEVEL TASKS COLLECTION (for TaskManager)
    // ========================================================================
    match /tasks/{taskId} {
      // Teachers can read their own tasks, students can read if enrolled in an assigned room
      allow read: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid || 
        isEnrolledInAnyAssignedRoom(resource.data)
      );
      
      // Teachers can create tasks
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      
      // Teachers can update/delete their own tasks
      allow update, delete: if isSignedIn() && resource.data.teacherId == request.auth.uid;
    }
    
    // ========================================================================
    // ANALYTICS LOGS COLLECTION
    // ========================================================================
    match /analytics_logs/{logId} {
      // Teachers can read analytics for their classrooms
      allow read: if isSignedIn() && get(/databases/$(database)/documents/classrooms/$(resource.data.classroomId)).data.teacherId == request.auth.uid;
      
      // Teachers can create analytics for their classrooms
      allow create: if isSignedIn() && get(/databases/$(database)/documents/classrooms/$(request.resource.data.classroomId)).data.teacherId == request.auth.uid;
      
      // Teachers can update analytics
      allow update: if isSignedIn() && get(/databases/$(database)/documents/classrooms/$(resource.data.classroomId)).data.teacherId == request.auth.uid;
      
      // Teachers can delete analytics from their classrooms
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/classrooms/$(resource.data.classroomId)).data.teacherId == request.auth.uid;
    }
  }
}
